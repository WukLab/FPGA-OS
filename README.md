# FPGA

Codebase Organization Principles:
- Make each subfolder be an IP on its own. This means it should have its own
  scripts, rtl or hls code, and testbench.
- Hierarchy IPs will have dependency. We need to express the order explicitly
  in corresponding building scripts.
- Final large project should be expressed in a diagram or static RTL code
  that ultilizing small IP cores.
- Overall, this project will consist many small IPs, and they will be used
  internally to build large ones. Our goal is to be able to reuse IPs as much as
  possible, and be able to construct new IPs easily.

Codebase Directories:
- `alloc/`: memory allocator
- `mm/`: memory management
- `net/`: network
- `tools/`: various helpers
- `scripts/`: template script files
- `samples`: some sample projects
- `/sys`: some high-level combined large IPs within each subsystem.
- Generated
	- `generated_ip/`: all generated IPs sleep here
	- `generated_hls_project/`: Vivado HLS project
	- `generated_vivado_project/`: Vivado project

Coding Format:
- General
	- Make your readable for others.
	- Remove ending spaces and tabs.
- Vivado HLS
	- All Vivado HLS script use `run_hls.tcl` name.
	- C++: try to use Linux kernel coding style.
- Verilog

## HOWTO use the Vivado script

The goal of using scripts are two-fold
- Make the building process easier
- Use Git to track source files only.
  Because by default Vivado will create bunch files, and all of them should not
  be tracked by Git. In this project, all Vivado project-mode related files
  are placed under `generated_vivado_project/` folder, at the same folder
  where the corresponding script and source code are.

Those Vivado project-mode scripts are generated by Vivado itself. And those
scripts can be used to rebuild the whole project AS IS.

Those are my unformal steps to create and hack those scripts:

- Run the script:
	- `vivado -mode tcl -source run_vivado.tcl`
		- A new `generated_vivado_project/` will be created at the current folder
		- A new IP will be packaged and exported into `generated_ip/` folder.
	- If you don't want to type it everytime, use a simple Makefile.
- Create the script:
	- Use Vivado GUI to create a new project, add existing sources/tb/xdc, set part.
	- Use `write_project_tcl` to generate the script. You SHOULD let the new
	  script know that the going-to-be-rebuilt project should be placed under
	  under folder's `generated_vivado_project`. And you SHOULD name the script
	  to `run_vivado.tcl`. For example: `write_project_tcl -no_copy_sources -force -target_proj_dir ./generated_vivado_project ./run_vivado.tcl`
- Add IP paths:
	- This SHOULD be added to every script.
	- All our generated IPs are in `generated_ip/` folder. This makes IP tracking easier.
	  You can add few lines to the script so that Vivado knows where to look for new IPs.
	  Check out `scripts/template_vivado_ip.tcl` for those lines.
- Package IP automatically:
	- This SHOULD be added to every script.
	- We want to let the script to package IP automatially. This can be achieved by adding
	  few lines at the end of the script. Note that you need to specify the destination location,
	  the name of the IP, and so on. All our generated IPs are in `generated_ip/`. For example,
	  `ipx::package_project -root_dir ../../generated_ip/mm_axi_wrapper -vendor wuklab -library user -taxonomy UserIP -import_files -set_current false -force`
- Add more source/xdc/simulation files:
	- First solution, manually change the generated script. Try to find out how those
	  existing files are added, then you can modify the script in a similar way. Tips:
	  search `top.v`, `add_files` etc.
	- Second solution, add files via Vivado GUI, and then use `write_project_tcl` again
	  to generate another script. Then check out the differences.
- Other settings:
	- IMPORTANT!
	- Whatever changes you made via Vivado GUI (e.g., compiling order, xdc order, simulation top file),
	  and if you want to save it for others to use, you need to use `write_project_tcl` to generate a new script
	  and save the corresponding changes. Once you get familiar with Vivado commands, you
	  should be able to do manually by changing script.

For now, you can find an example script at the `mm/axi_wrapper/run_vivado_arty_a7.tcl`.

## HOWTO use the Vivado HLS script

The Vivado HLS script is relatively easier than Vivado script.
You can find the template script in `scripts/template_run_hls.tcl`.
You SHOULD customize the parts, files added, frequency, and so.
If you want to automatically build multiple HLS under the same folder, use the `scripts/template_generate_hls.sh`
Check out `samples/` for examples.

## References
- [UG1118 Vivado Creating and Packaging Custom IP](https://www.xilinx.com/support/documentation/sw_manuals/xilinx2018_2/ug1118-vivado-creating-packaging-custom-ip.pdf)
